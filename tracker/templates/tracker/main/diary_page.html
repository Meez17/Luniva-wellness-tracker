{% extends "tracker/base.html" %}
{% block title %}My Diary{% endblock %}
{% load static %}

{% block content %}

<div class="container mt-5">
  <div class="text-center mb-4 p-4 header-journal pastel-bg" style=" border-radius: 12px;">
      <div class="text-center mb-4">
        <img src="{% static 'images/200.gif' %}" alt="Journaling gif" style="max-width: 200px;"> </div>
    <h2 class="mb-2" style="color: #A18BD0;">My Personal Diary</h2>
    <p class="lead text-light" style="colour:  #ECA1A6;">This space is yours. Revisit your thoughts, goals, and reflections.</p>
    <p><em style="color:  #ECA1A6;">Use the calendar below to navigate entries by date. Click "+ Add Entry" to pen down new reflections.</em></p>
  </div>

  <!-- Add Entry + Search -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 style="color:#A18BD0;">My Diary</h4>
    <a href="{% url 'add_diary' %}" class="btn btn-sm btn-purple">+ Add Entry</a>
  </div>

  <form method="GET" action="{% url 'diary_page' %}" class="mb-4 search-bar">
    <input type="text" name="q" class="form-control" placeholder="Search your diary...">
    <button type="submit" class="btn btn-sm btn-purple">Search</button>
    <a href="{% url 'diary_page' %}" class="btn btn-sm btn-purple">Clear</a>
  </form>

  <div class="row">
    <!-- Left Column -->
    <div class="col-md-4">
<!-- Prompts -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <div class="section-header-blue">ğŸ’¬ Prompt Reflections</div>
    <!-- Clickable Prompt of the Day -->
    <p id="promptText" class="text-muted" style="cursor:pointer;" onclick="changePrompt()">
      <em>{{ prompt_of_the_day }}</em>
    </p>

    {% for p in prompt_answers %}
      <div class="prompt-card">
        <strong>{{ p.prompt }}</strong><br>
        <em>{{ p.answer }}</em><br>
        <small>{{ p.date|date:"M d" }}</small><br>
        <a href="{% url 'edit_prompt' p.id %}" class="link-pink">Edit</a> |
        <a href="{% url 'delete_prompt' p.id %}" class="link-pink" onclick="return confirm('Delete this prompt?')">Delete</a>
      </div>
    {% empty %}
      <p>No prompt answers yet.</p>
    {% endfor %}
    <a href="{% url 'add_prompt' %}" class="btn btn-sm btn-purple mt-2">+ Add Prompt</a>
  </div>
</div>

{% if prompt_answers.has_other_pages %}
  <nav>
    <ul class="pagination">
      {% if prompt_answers.has_previous %}
        <li>
          <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}prompt_page={{ prompt_answers.previous_page_number }}">â†</a>
        </li>
      {% endif %}
      <li class="active"><span>{{ prompt_answers.number }}</span></li>
      {% if prompt_answers.has_next %}
        <li>
          <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}prompt_page={{ prompt_answers.next_page_number }}">â†’</a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

<!-- Gratitude -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <div class="section-header-blue">ğŸ™ Gratitude Reflections</div>
    {% for g in gratitude_entries %}
      <div class="gratitude-card">
        {{ g.content }}<br>
        <small>{{ g.date|date:"M d" }}</small><br>
        <a href="{% url 'edit_gratitude' g.id %}" class="link-pink">Edit</a> |
        <a href="{% url 'delete_gratitude' g.id %}" class="link-pink" onclick="return confirm('Delete this gratitude entry?')">Delete</a>
      </div>
    {% empty %}
      <p>No gratitude entries yet.</p>
    {% endfor %}
    <a href="{% url 'add_gratitude' %}" class="btn btn-sm btn-purple mt-2">+ Add Gratitude</a>
  </div>
</div>

{% if gratitude_entries.has_other_pages %}
  <nav>
    <ul class="pagination">
      {% if gratitude_entries.has_previous %}
        <li>
          <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}gratitude_page={{ gratitude_entries.previous_page_number }}">â†</a>
        </li>
      {% endif %}
      <li class="active"><span>{{ gratitude_entries.number }}</span></li>
      {% if gratitude_entries.has_next %}
        <li>
          <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}gratitude_page={{ gratitude_entries.next_page_number }}">â†’</a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

      <!-- Calendar -->
      <div class="card mb-4 shadow-sm" style="width: 90%; margin: auto;">
        <div class="card-body">
          <h5 class="card-title">ğŸ“… Calendar</h5>
          <div id="diaryCalendar"></div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-md-8">
      {% for entry in entries %}
        <div class="card mb-4 shadow-sm card-diary">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h4>{{ entry.mood_icon }} {{ entry.title }}</h4>
              <div>
                <a href="{% url 'edit_diary' entry.id %}" class="btn btn-sm btn-pink me-2">Edit</a>
                <a href="{% url 'delete_diary' entry.id %}" class="btn btn-sm btn-pink" onclick="return confirm('Delete this diary entry?')">Delete</a>
              </div>
            </div>
            <p><em>{{ entry.date }}</em></p>
            <blockquote class="blockquote">{{ entry.content }}</blockquote>
            {% if entry.short_term or entry.medium_term or entry.long_term %}
              <hr>
              <h6 style="color: #2D3142;">ğŸ¯ What do you want to achieve?</h6>
              {% if entry.short_term %}<p><strong>Today:</strong> {{ entry.short_term }}</p>{% endif %}
              {% if entry.medium_term %}<p><strong>This Week:</strong> {{ entry.medium_term }}</p>{% endif %}
              {% if entry.long_term %}<p><strong>This Month:</strong> {{ entry.long_term }}</p>{% endif %}
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="text-muted text-center">No diary entries found yet. Start writing to reflect and grow ğŸŒ±</p>
      {% endfor %}

      <!-- Pagination -->
      {% if entries.has_other_pages %}
        <nav aria-label="Diary pagination">
          <ul class="pagination justify-content-center">
            {% if entries.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ entries.previous_page_number }}">â†</a></li>
            {% endif %}
            <li class="page-item active"><span class="page-link">{{ entries.number }}</span></li>
            {% if entries.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ entries.next_page_number }}">â†’</a></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}

<script>
const prompts = [
  "What made you smile today?",
  "What are you proud of this week?",
  "Whatâ€™s something youâ€™re letting go of?",
  "What do you need more of right now?",
  "Whatâ€™s a memory that brings you peace?",
  " Whatâ€™s a challenge you overcame recently?",
  "Whatâ€™s something new you learned about yourself?",
  "Whatâ€™s a small act of kindness you experienced?",
  "Whatâ€™s a goal youâ€™re working towards?",
  "Whatâ€™s a dream you have for the future?",
  "Whatâ€™s a habit you want to build?",
  "Whatâ€™s a book or movie that inspired you?",
  "Whatâ€™s a place you want to visit and why?",
  "Whatâ€™s a skill you want to learn?",
  "Whatâ€™s a person who positively impacted your life?",
  "Whatâ€™s a moment when you felt truly at peace?",
  "Whatâ€™s a value thatâ€™s important to you?",
  "Whatâ€™s a way you can practice self-care this week?",
  "Whatâ€™s a recent accomplishment youâ€™re proud of?",
  "Whatâ€™s a lesson you learned from a mistake?",
  "Whatâ€™s a way you can give back to your community?",
  "Whatâ€™s a way you can step out of your comfort zone?",
  "Whatâ€™s a way you can nurture your creativity?",
  "Whatâ€™s a way you can connect with nature?",
  "Whatâ€™s a way you can strengthen a relationship?",
  "Whatâ€™s a way you can simplify your life?",
  "Whatâ€™s a way you can practice mindfulness?",

];
function changePrompt() {
  const current = document.getElementById("promptText");
  const next = prompts[Math.floor(Math.random() * prompts.length)];
  current.innerHTML = `<em>${next}</em>`;
}
</script>

<!-- Diary calendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('diaryCalendar');
  if (!calendarEl) return;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 400,
    headerToolbar: {
      left: 'prev,next',
      center: 'title',
      right: ''
    },
    selectable: true,
    dateClick: function(info) {
      window.location.href = `/diary/add/?date=${info.dateStr}`;
    },
    events: async function(fetchInfo, successCallback, failureCallback) {
      try {
        const res = await fetch("{% url 'diary_entries_json' %}");
        const data = await res.json();
        const events = data.map(e => ({
          title: e.title || 'Diary',
          start: e.date,
          extendedProps: { content: e.content, id: e.id }
        }));
        successCallback(events);
      } catch (err) {
        failureCallback(err);
      }
    },
    eventClick: function(info) {
      const entryId = info.event.extendedProps.id;
      if (entryId) {
            window.location.href = `{% url 'edit_diary' 0 %}`.replace('0', entryId);
      }
    }
  });

  calendar.render();
});
</script>

{% endblock %}